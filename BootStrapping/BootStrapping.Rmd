---
title: "Bootstrapping"
author: "Group 780 AAU"
date: "2023-12-05"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Bootstrapping
Bootstrapping is a method which samples a dataset many times in order to test the validty of that dataset. It can be used in combination with Principle Component Analysis to create confidence elipses which show if enough participants have been sampled
The code from this document is from another research group form Aalborg university group 780 - Credits to Christoffer Lyholm
```{r}
install.packages("psych");
install.packages("tidyverse");
install.packages("Hmisc");
install.packages("ggcorrplot");
install.packages("FactoMineR");
install.packages("factoextra");
install.packages("reshape2");
install.packages("reshape");
install.packages("Rmisc");
install.packages("simplermarkdown");
```
```{r}
library(psych);
library(tidyverse);
library(Hmisc);
library(ggcorrplot);
library(FactoMineR);
library(factoextra);
library(reshape2);
library(reshape);
library(Rmisc);
library(simplermarkdown);
```


```{r}
DF <- read.csv("MeansForEachBeer.csv")
DF$Row <- as.factor(DF$Row)
attributes <- colnames(DF[c(2: length(DF))])

pcaModel <- PCA(DF[,-1], graph = FALSE) # -1 to exclude the "knob" column

```

# Data initialization


```{r}
fviz_screeplot(pcaModel, addlabels = TRUE, ylim = c(0, 80))
eigenValues <- data.frame(get_eig(pcaModel)) # component 1 explains 75% of variance, component 2 20%
pcaModelResults <- get_pca(pcaModel)
loadings <- data.frame(cbind(attributes, pcaModelResults$coord[,1:2]))
md_table(loadings)
fviz_pca_biplot(pcaModel, repel = TRUE)
```

```{r}
fviz_pca_ind(pcaModel,
             label = "none", # hide individual labels
             habillage = DF$ID, # color by groups
             palette = c('set1'),
             addEllipses = TRUE # Concentration ellipses
             )
```

dataFrameWide <- read.csv('./RatingDataWide.csv', stringsAsFactors=TRUE)
dataFrameLong <- read.csv('./RatingDataLong.csv', stringsAsFactors=TRUE, sep = ";")
scales <- c("Force Into Step", "Large step size", "Range", "Resistance out of step", "Unstable", "Preference")

dataFrameWide$ID <- as.factor(dataFrameWide$ID)
dataFrameWide$Knob <- as.factor(dataFrameWide$Knob)
dataFrameWide$Repetition <- as.factor(dataFrameWide$Repetition)

data <- select(dataFrameWide, Preference,ForceIntoStep, LargeStepSize, Range, ResistanceOutOfStep, Unstable)

# Data examination for validity and if fit for PCA/factor analysis
cronbachData <- data.frame(ForceIntoStep = c(dataFrameWide$ForceIntoStep),
                   LargeStepSize = c(dataFrameWide$LargeStepSize),
                   Range = c(dataFrameWide$Range),
                   ResistanceOutOfStep = c(dataFrameWide$ResistanceOutOfStep),
                   Unstable = c(dataFrameWide$Unstable))


psych::alpha(cronbachData, check.keys = TRUE) # With the auto check the functions rates "range" and "Unstable" as pointing in opposite direction. keys = c(... 1 for normal, -1 inverse)

# KMO
psych::KMO(data)
psych::KMO(dataCor)

# Pca with means of all participants grouped
## data prep
knobMeans <- aggregate(dataFrameLong$Score, by=list(dataFrameLong$Knob, dataFrameLong$Scale), FUN=mean)
knobMeans <- data.frame(knobMeans)
knobMeans <- dplyr::rename(knobMeans, Knob = Group.1, Scale = Group.2, Mean = x)
knobMeans <- reshape(knobMeans, idvar="Knob", timevar = "Scale", direction = "wide")
prefCol <- aggregate(dataFrameLong$Preference, by = list(dataFrameLong$Knob), FUN=mean)
prefCol <- dplyr::rename(prefCol, Knob = Group.1, Mean = x)
knobMeans <- cbind(knobMeans, prefCol$Mean)
rm(prefCol)
knobMeans <- dplyr::rename(knobMeans, "Force into step" = "Mean.Force into step", "Large step size" = "Mean.Large step size", "Range" = "Mean.Range", "Resistance out of step" = "Mean.Resistance out of step", "Unstable" = "Mean.Unstable", "Preference" = "prefCol$Mean")
knobMeans$Knob <- as.factor(knobMeans$Knob)
md_table(head(knobMeans))

## correlation matrix
meansCor <- cor(knobMeans[,2:7])
ggcorrplot(meansCor, hc.order = TRUE, lab = TRUE)

## PCA
pcaModel <- PCA(knobMeans[,-1], graph = FALSE) # -1 to exclude the "knob" column
fviz_screeplot(pcaModel, addlabels = TRUE, ylim = c(0, 80))
eigenValues <- data.frame(get_eig(pcaModel)) # component 1 explains 75% of variance, component 2 20%
pcaModelResults <- get_pca(pcaModel)
loadings <- data.frame(cbind(scales, pcaModelResults$coord[,1:2]))
md_table(loadings)

## Scores plot
fviz_pca_ind(pcaModel,
             #label = "none", # hide individual labels
             habillage = knobMeans$Knob, # color by groups
             palette = c('set1'),
             addEllipses = TRUE # Concentration ellipses
             )

## Biplot
fviz_pca_biplot(pcaModel, repel = TRUE)


# PCA with means of repetitions but participants seperate
## data prep
testMeans <- aggregate(dataFrameLong$Score, by=list(dataFrameLong$ID, dataFrameLong$Knob, dataFrameLong$Scale), FUN=mean)
testMeans <- data.frame(testMeans)
testMeans <- dplyr::rename(testMeans, ID = Group.1, Knob = Group.2, Scale = Group.3, Mean = x)
testMeans <- reshape(testMeans, idvar=c("Knob", "ID"), timevar = "Scale", direction = "wide")
prefCol <- aggregate(dataFrameLong$Preference, by = list(dataFrameLong$ID, dataFrameLong$Knob), FUN=mean)
prefCol <- dplyr::rename(prefCol, ID = Group.1, Knob = Group.2, Mean = x)
testMeans <- cbind(testMeans, prefCol$Mean)
rm(prefCol)
testMeans <- dplyr::rename(testMeans, "Force into step" = "Mean.Force into step", "Large step size" = "Mean.Large step size", "Range" = "Mean.Range", "Resistance out of step" = "Mean.Resistance out of step", "Unstable" = "Mean.Unstable", "Preference" = "prefCol$Mean")
testMeans$Knob <- as.factor(testMeans$Knob)
md_table(head(testMeans))

## correlation matrix
testCor <- cor(testMeans[,3:8])
ggcorrplot(testCor, hc.order = TRUE, lab = TRUE)

## PCA
pcaTest <- PCA(testMeans[,3:8], graph = FALSE)
fviz_screeplot(pcaTest, addlabels = TRUE, ylim = c(0, 80))
eigenValues <- data.frame(get_eig(pcaTest)) # component 1 explains 75% of variance, component 2 20%
pcaTestResults <- get_pca(pcaTest)
loadingsTest <- data.frame(cbind(scales, pcaTestResults$coord[,1:2]))
md_table(loadingsTest)

## scores plot with ellipses
fviz_pca_ind(pcaTest,
             label = "none", # hide individual labels
             habillage = testMeans$Knob, # color by groups
             palette = c('set1'),
             addEllipses = TRUE # Concentration ellipses
             )

## biplot
fviz_pca_biplot(pcaTest, repel = TRUE, habillage = testMeans$Knob)

# PCA https://www.datacamp.com/tutorial/pca-analysis-r


# Confidence intervals for each repetition
repStats <- summarySE(dataFrameLong, measurevar = "Score", groupvars = c("Scale", "Repetition"), conf.interval = 0.95)
pd <- position_dodge(0.2) # avoid overlapping error bars
ggplot(repStats, aes(x = Scale, y = Score, colour = Repetition)) +
    geom_errorbar(aes(ymin = Score-ci, ymax = Score+ci), width = .1, position = pd) +
    geom_line(aes(group = Repetition),position = pd) +
    geom_point(position = pd)
